<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>VILL: Markerless Surface Tracking</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; }
    
    /* 聊天室 UI - 必須設定 pointer-events 以允許穿透點擊 */
    #overlay-ui {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none; /* 讓點擊能穿透 UI 到底下的 AR 場景 */
      z-index: 999;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
    }

    /* 實際可互動的區域要開啟 pointer-events */
    #chat-container {
      width: 90%;
      max-width: 400px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px 12px 0 0;
      padding: 15px;
      margin-bottom: 20px;
      pointer-events: auto; /* 恢復聊天室的點擊功能 */
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }

    #chat-history {
      height: 150px;
      overflow-y: auto;
      margin-bottom: 10px;
      font-size: 14px;
    }
    .message { margin: 5px 0; padding: 5px 10px; border-radius: 8px; }
    .ai-msg { background: #e1f5fe; color: #0277bd; }
    .user-msg { background: #2e7d32; color: white; text-align: right; }
    
    .input-area { display: flex; gap: 5px; }
    input { flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
    button { padding: 8px 15px; background: #0277bd; color: white; border: none; border-radius: 4px; }
    
    /* 提示字卡 */
    #ar-prompt {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 14px;
      pointer-events: none;
      display: none; /* 進入 AR 後顯示 */
    }
  </style>
</head>

<body>
  <div id="overlay-ui">
    <div id="ar-prompt">Scanning floor... Tap to place map</div>
    
    <div id="chat-container">
      <div id="chat-history">
        <div class="message ai-msg"><strong>AI Expert:</strong> Welcome! Scan the floor to place the Bac Ninh map.</div>
      </div>
      <div class="input-area">
        <input type="text" id="chat-input" placeholder="Ask about 'China Plus One'...">
        <button id="send-btn">Send</button>
      </div>
    </div>
  </div>

  <a-scene 
    webxr="optionalFeatures: hit-test, dom-overlay; overlayElement: #overlay-ui"
    ar-hit-test="target: #map-content; type: map">
    
    <a-entity id="reticle" visible="false">
      <a-ring color="white" radius-inner="0.05" radius-outer="0.06" rotation="-90 0 0"></a-ring>
      <a-circle color="white" radius="0.01" rotation="-90 0 0"></a-circle>
    </a-entity>

    <a-entity id="map-content" visible="false" scale="0.5 0.5 0.5">
      
      <a-box position="-0.5 0.25 0" color="#ef5350" depth="0.5" height="0.5" width="0.5"></a-box>
      <a-text value="Samsung" position="-0.5 0.8 0" align="center" scale="2 2 2" color="black"></a-text>
      
      <a-sphere position="0.8 0.25 0.5" radius="0.25" color="#42a5f5"></a-sphere>
      <a-text value="Hai Phong Port" position="0.8 0.8 0.5" align="center" scale="2 2 2" color="black"></a-text>

      <a-cylinder start="0 0 0" end="1 1 1" color="#ffeb3b" height="1.5" radius="0.02" position="0.15 0.25 0.25" rotation="90 0 45"></a-cylinder>
      <a-text value="Supply Route" position="0.15 0.5 0.25" align="center" scale="1.5 1.5 1.5" color="black"></a-text>

      <a-plane rotation="-90 0 0" width="3" height="3" color="#a5d6a7" opacity="0.5"></a-plane>

    </a-entity>
    
    <a-light type="ambient" intensity="1"></a-light>
    <a-light type="directional" position="10 10 5" intensity="1"></a-light>

  </a-scene>

  <script>
    // ===============================================
    // 自訂 AR Hit Test 邏輯
    // ===============================================
    AFRAME.registerComponent('ar-hit-test', {
      init: function () {
        this.xrHitTestSource = null;
        this.viewerSpace = null;
        this.refSpace = null;
        
        // 綁定 UI 元素
        this.reticle = document.querySelector('#reticle');
        this.content = document.querySelector('#map-content');
        this.prompt = document.querySelector('#ar-prompt');
        
        // 點擊事件：放置模型
        this.el.sceneEl.addEventListener('click', () => {
          if (!this.reticle.getAttribute('visible')) return;
          
          // 將內容移動到瞄準圈的位置
          const position = this.reticle.getAttribute('position');
          const rotation = this.reticle.getAttribute('rotation');
          
          this.content.setAttribute('position', position);
          this.content.setAttribute('rotation', rotation); // 讓地圖面對你
          this.content.setAttribute('visible', 'true');
          
          // 隱藏瞄準圈，改變提示
          this.reticle.setAttribute('visible', 'false');
          this.prompt.innerText = "Map placed! Chat with AI now.";
          
          // 移除 Hit Test (鎖定位置) - 選擇性
          this.xrHitTestSource = null; 
        });

        // 監聽 WebXR Session 開始
        this.el.sceneEl.addEventListener('enter-vr', () => {
          this.prompt.style.display = 'block';
          const session = this.el.sceneEl.renderer.xr.getSession();
          
          // 請求 Hit Test
          session.requestReferenceSpace('viewer').then((space) => {
            this.viewerSpace = space;
            session.requestHitTestSource({ space: this.viewerSpace }).then((source) => {
              this.xrHitTestSource = source;
            });
          });
          
          session.requestReferenceSpace('local').then((space) => {
            this.refSpace = space;
          });
        });
      },

      tick: function () {
        if (!this.xrHitTestSource || !this.viewerSpace || !this.refSpace) return;
        
        const frame = this.el.sceneEl.renderer.xr.getFrame();
        if (!frame) return;
        
        // 取得 Hit Test 結果
        const hitTestResults = frame.getHitTestResults(this.xrHitTestSource);
        
        if (hitTestResults.length > 0) {
          const pose = hitTestResults[0].getPose(this.refSpace);
          
          // 顯示瞄準圈
          this.reticle.setAttribute('visible', 'true');
          this.reticle.object3D.position.copy(pose.transform.position);
          // 稍微平滑旋轉會更好，這裡直接複製
          this.reticle.object3D.quaternion.copy(pose.transform.orientation);
        } else {
          // 掃不到平面時隱藏瞄準圈
          this.reticle.setAttribute('visible', 'false');
        }
      }
    });

    // ===============================================
    // Mock AI 聊天邏輯 (同前版)
    // ===============================================
    const chatHistory = document.getElementById('chat-history');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');

    function appendMessage(sender, text, className) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${className}`;
      msgDiv.innerHTML = `<strong>${sender}:</strong> ${text}`;
      chatHistory.appendChild(msgDiv);
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function getMockResponse(text) {
      const t = text.toLowerCase();
      if (t.includes('why') || t.includes('reason')) return "Vietnam's proximity to China allows for a cost-effective 'China Plus One' strategy.";
      if (t.includes('tax') || t.includes('cost')) return "Bac Ninh offers a 4-year tax holiday for high-tech investments.";
      return "Interesting question. Try asking about 'Infrastructure' or 'Supply Chain'.";
    }

    sendBtn.addEventListener('click', () => {
      const txt = chatInput.value.trim();
      if(!txt) return;
      appendMessage('You', txt, 'user-msg');
      chatInput.value = '';
      setTimeout(() => {
        appendMessage('AI Expert', getMockResponse(txt), 'ai-msg');
      }, 800);
    });
  </script>
</body>
</html>
