<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>VILL Prototype: Bac Ninh Hub</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <style>
    body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    
    /* AI 聊天室 UI 疊加層 */
    #chat-container {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 400px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      z-index: 1000;
    }
    #chat-history {
      height: 200px;
      overflow-y: auto;
      padding: 15px;
      font-size: 14px;
      line-height: 1.4;
    }
    .message { margin-bottom: 10px; padding: 8px 12px; border-radius: 8px; max-width: 85%; }
    .user-msg { background: #007bff; color: white; align-self: flex-end; margin-left: auto; }
    .ai-msg { background: #e9ecef; color: #333; align-self: flex-start; }
    #chat-input-area {
      display: flex;
      border-top: 1px solid #ddd;
      padding: 10px;
    }
    #chat-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      outline: none;
    }
    #send-btn {
      margin-left: 10px;
      padding: 8px 15px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #send-btn:disabled { background: #999; }
  </style>
</head>
<body style="margin: 0px; overflow: hidden;">

  <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
    
    <a-marker preset="hiro">
      <a-box position="0 0.5 0" material="color: red; opacity: 0.8;"></a-box>
      <a-text value="Bac Ninh OSAT Hub\nSamsung & Foxconn" position="-1 1.2 0" color="yellow" scale="1 1 1" align="center"></a-text>
      <a-plane position="0 0.1 0" rotation="-90 0 0" width="2" height="2" material="color: #0044ff; opacity: 0.3;"></a-plane>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <div id="chat-container">
    <div id="chat-history">
      <div class="message ai-msg">
        <strong>VILL Expert:</strong> Hello! Point your camera at the Hiro marker to see the Bac Ninh map. Ask me anything about the "China Plus One" strategy or Vietnam's OSAT infrastructure!
      </div>
    </div>
    <div id="chat-input-area">
      <input type="text" id="chat-input" placeholder="Ask about infrastructure or supply chain...">
      <button id="send-btn">Send</button>
    </div>
  </div>

  <script>
    // ==========================================
    // ⚠️ 請在此處填寫您的 OpenAI API Key
    // 注意：正式上線時 API Key 絕對不能放在前端！
    // 這裡僅供本機 Prototype 測試使用。
    // ==========================================
    const OPENAI_API_KEY = "sk-YOUR_API_KEY_HERE"; 

    const chatHistory = document.getElementById('chat-history');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');

    // VILL 計畫專屬的 System Prompt (對應 Module 1 & 2)
    const systemPrompt = `
      You are an AI virtual coach for the VILL project, acting as a senior Southeast Asia semiconductor supply chain expert. 
      The student is learning about "China Plus One" and the OSAT (Outsourced Semiconductor Assembly and Test) industry in Vietnam.
      Rules:
      1. Be concise (max 3-4 sentences per reply).
      2. Naturally use ESP (English for Specific Purposes) terms like: OSAT, Geopolitics, Infrastructure, Yield Rate, Compliance.
      3. Always end your response with a brief, gentle "Language Tip:" to correct grammar or suggest a more professional way to phrase their question, reducing their Foreign Language Anxiety (FLSA).
    `;

    let messages = [
      { role: "system", content: systemPrompt }
    ];

    function appendMessage(sender, text, className) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${className}`;
      msgDiv.innerHTML = `<strong>${sender}:</strong> ${text}`;
      chatHistory.appendChild(msgDiv);
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    async function sendMessage() {
      const userText = chatInput.value.trim();
      if (!userText) return;

      if (OPENAI_API_KEY === "sk-YOUR_API_KEY_HERE") {
        alert("請先在原始碼中替換您的 OpenAI API Key！");
        return;
      }

      // 顯示用戶訊息
      appendMessage('You', userText, 'user-msg');
      chatInput.value = '';
      sendBtn.disabled = true;
      sendBtn.innerText = 'Thinking...';

      messages.push({ role: "user", content: userText });

      try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${OPENAI_API_KEY}`
          },
          body: JSON.stringify({
            model: 'gpt-4o-mini', // 為了速度與成本，使用 mini 模型
            messages: messages,
            temperature: 0.7
          })
        });

        const data = await response.json();
        const aiResponse = data.choices[0].message.content;
        
        // 顯示 AI 訊息
        appendMessage('VILL Expert', aiResponse, 'ai-msg');
        messages.push({ role: "assistant", content: aiResponse });

      } catch (error) {
        console.error(error);
        appendMessage('System', 'API Request Failed. Check console.', 'ai-msg');
      } finally {
        sendBtn.disabled = false;
        sendBtn.innerText = 'Send';
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') sendMessage();
    });
  </script>
</body>
</html>
