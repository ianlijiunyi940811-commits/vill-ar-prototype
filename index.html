<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>VILL: Strategic Map AR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
  
  <style>
    body { font-family: 'Roboto', sans-serif; margin: 0; overflow: hidden; }

    /* 1. 全螢幕 UI 層 (穿透層) */
    #overlay {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: 100;
      pointer-events: none; /* 讓手指點擊能穿透到 AR 場景 */
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
    }

    /* 2. 掃描提示框 */
    #reticle-prompt {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 15px 25px;
      border-radius: 30px;
      text-align: center;
      font-size: 16px;
      pointer-events: none;
      display: none; /* 進入 AR 後才顯示 */
    }

    /* 3. AI 聊天室 (互動層) */
    #chat-panel {
      width: 100%;
      height: 35%;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px 20px 0 0;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      pointer-events: auto; /* 恢復此區域的點擊功能 */
      transition: transform 0.3s ease;
    }

    #chat-header {
      padding: 12px;
      background: #0277bd;
      color: white;
      text-align: center;
      font-weight: bold;
      border-radius: 20px 20px 0 0;
    }

    #chat-history {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      font-size: 14px;
    }

    .msg { margin-bottom: 8px; padding: 8px 12px; border-radius: 12px; max-width: 85%; line-height: 1.4; }
    .ai { background: #e1f5fe; color: #01579b; align-self: flex-start; }
    .user { background: #4caf50; color: white; margin-left: auto; }

    #input-box {
      display: flex;
      padding: 10px;
      background: white;
      border-top: 1px solid #eee;
    }
    #msg-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
    #send-btn { margin-left: 10px; padding: 8px 20px; background: #0277bd; color: white; border: none; border-radius: 20px; font-weight: bold; }

    /* 進入 AR 的按鈕 (A-Frame 預設樣式會被此覆蓋，這裡保持預設即可) */
  </style>
</head>

<body>

  <div id="overlay">
    <div id="reticle-prompt">
      Wait for the circle...<br>Tap screen to place Map
    </div>
    
    <div id="chat-panel">
      <div id="chat-header">VILL Strategy Coach (AI)</div>
      <div id="chat-history">
        <div class="msg ai"><strong>AI:</strong> Welcome. Scan the floor/table. When you see the white circle, tap to deploy the <strong>North Vietnam Strategic Map</strong>.</div>
      </div>
      <div id="input-box">
        <input type="text" id="msg-input" placeholder="Ask about 'China Plus One'...">
        <button id="send-btn">Send</button>
      </div>
    </div>
  </div>

  <a-scene 
    webxr="optionalFeatures: hit-test, dom-overlay; overlayElement: #overlay"
    ar-hit-test="target: #map-pivot; type: map;"
    renderer="physicallyCorrectLights: true; colorManagement: true; exposure: 1;"
    shadow="type: pcfsoft">

    <a-assets>
      <img id="map-texture" src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e6/Vietnam_location_map_topographic.png/640px-Vietnam_location_map_topographic.png">
    </a-assets>

    <a-light type="ambient" intensity="0.5"></a-light>
    <a-light type="directional" position="10 15 10" intensity="1" castShadow="true"></a-light>

    <a-entity id="reticle" ar-hit-test-reticle>
      <a-ring rotation="-90 0 0" radius-inner="0.05" radius-outer="0.06" color="white" opacity="0.8"></a-ring>
      <a-circle rotation="-90 0 0" radius="0.01" color="white"></a-circle>
    </a-entity>

    <a-entity id="map-pivot" position="0 0 -1000" visible="false">
      
      <a-plane 
        rotation="-90 0 0" 
        width="1.2" height="1.8" 
        src="#map-texture"
        material="roughness: 1; metalness: 0;"
        shadow="receive: true">
      </a-plane>

      <a-entity position="0.1 0.05 -0.5">
        <a-cone position="0 0.15 0" radius-bottom="0.01" radius-top="0.08" height="0.15" color="#d32f2f" shadow="cast: true"></a-cone>
        <a-sphere position="0 0.22 0" radius="0.08" color="#d32f2f" shadow="cast: true"></a-sphere>
        <a-text value="Bac Ninh\n(Samsung)" position="0 0.4 0" align="center" scale="0.5 0.5 0.5" color="black" side="double"></a-text>
        <a-circle rotation="-90 0 0" radius="0.05" color="black" opacity="0.3"></a-circle>
      </a-entity>

      <a-entity position="0.3 0.05 -0.3">
        <a-cone position="0 0.15 0" radius-bottom="0.01" radius-top="0.08" height="0.15" color="#1976d2" shadow="cast: true"></a-cone>
        <a-sphere position="0 0.22 0" radius="0.08" color="#1976d2" shadow="cast: true"></a-sphere>
        <a-text value="Hai Phong\n(Port)" position="0 0.4 0" align="center" scale="0.5 0.5 0.5" color="black" side="double"></a-text>
        <a-circle rotation="-90 0 0" radius="0.05" color="black" opacity="0.3"></a-circle>
      </a-entity>

      <a-entity position="0.15 0.05 -0.8">
        <a-cylinder height="0.05" radius="0.02" color="yellow"></a-cylinder>
        <a-text value="China Border" position="0 0.1 0" align="center" scale="0.4 0.4 0.4" color="black"></a-text>
      </a-entity>

      <a-entity line="start: 0.15 0.05 -0.8; end: 0.1 0.05 -0.5; color: #fbc02d; opacity: 0.8"></a-entity>
      <a-entity line="start: 0.1 0.05 -0.5; end: 0.3 0.05 -0.3; color: #fbc02d; opacity: 0.8"></a-entity>
      
      <a-plane position="0 0.8 -0.6" width="1" height="0.25" color="rgba(0,0,0,0.7)" look-at="[camera]">
          <a-text value="Supply Chain: 120km to Port" align="center" color="white"></a-text>
      </a-plane>

    </a-entity>
  </a-scene>

  <script>
    // ============================================
    // 1. WebXR 互動邏輯 (修正穩定性問題)
    // ============================================
    const scene = document.querySelector('a-scene');
    const mapPivot = document.querySelector('#map-pivot');
    const reticlePrompt = document.querySelector('#reticle-prompt');

    // 當進入 AR 模式時
    scene.addEventListener('enter-vr', () => {
      reticlePrompt.style.display = 'block';
    });

    // 監聽 "select" 事件 (這是 WebXR 標準的點擊事件，比 click 更穩)
    // 當瞄準圈鎖定平面並被點擊時觸發
    scene.addEventListener('ar-hit-test-select', () => {
        // 顯示地圖
        mapPivot.setAttribute('visible', 'true');
        // 隱藏提示
        reticlePrompt.style.display = 'none';
        reticlePrompt.innerText = "Map Deployed";
    });

    // ============================================
    // 2. AI 模擬邏輯 (Mock AI)
    // ============================================
    const chatHistory = document.getElementById('chat-history');
    const msgInput = document.getElementById('msg-input');
    const sendBtn = document.getElementById('send-btn');

    function addMsg(text, type, sender) {
      const div = document.createElement('div');
      div.className = `msg ${type}`;
      div.innerHTML = `<strong>${sender}:</strong> ${text}`;
      chatHistory.appendChild(div);
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function getAIResponse(text) {
      const t = text.toLowerCase();
      if (t.includes('why') || t.includes('location')) {
        return "Look at the map markers. **Bac Ninh** (Red Pin) is only 150km from the **China Border** (Yellow). This proximity creates a 'Zero-Inventory' advantage for incoming components. (Concept: Just-in-Time Delivery)";
      }
      if (t.includes('port') || t.includes('sea')) {
        return "The **Hai Phong Port** (Blue Pin) connects directly to global markets. The route from Bac Ninh to the port (Yellow Line) is crucial for exporting finished chips.";
      }
      if (t.includes('risk')) {
        return "A major risk is the single highway connecting these hubs. Congestion can delay shipments. Also, notice the distance from the power plants in the north.";
      }
      return "Try asking: 'Why is the border distance important?' or 'What is the role of the port?'";
    }

    sendBtn.addEventListener('click', () => {
      const txt = msgInput.value.trim();
      if(!txt) return;
      addMsg(txt, 'user', 'You');
      msgInput.value = '';
      setTimeout(() => addMsg(getAIResponse(txt), 'ai', 'VILL Coach'), 800);
    });
  </script>
</body>
</html>
